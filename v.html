<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Voice Gmail new (Serverless)</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f5f5f5; }
        .card { background: white; max-width: 600px; margin: auto; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        button { font-size: 3em; border: none; background: none; cursor: pointer; transition: transform 0.2s; }
        button:active { transform: scale(0.9); }
        #status { margin: 15px; font-weight: bold; color: #555; }
        .email-list { text-align: left; margin-top: 20px; font-size: 0.9em; }
        .email-item { background: #e3f2fd; padding: 10px; margin-bottom: 8px; border-radius: 5px; }
    </style>
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
</head>
<body>

    <div class="card">
        <h1>‚òÅÔ∏è Cloud Voice Email</h1>
        <p>Say: "Read my unread emails" or "Send email to [email] saying hello"</p>
        
        <button onclick="startAgent()">üéôÔ∏è</button>
        <div id="status">Tap mic to speak</div>
        <div class="email-list" id="displayArea"></div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // --- CONFIGURATION ---
        /*

        const API_KEY = "AIzaSyDxw8ulwIyPZJTeoIY0WJySj3HH4ns5r_U";
https://script.google.com/macros/s/AKfycbwDsIfTo6kViXw3w03m6GRdz6ke21bFTRg986xdEtXjcH3AYcNB-jMxDltjyxrqM6cN/exec
*/
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwDsIfTo6kViXw3w03m6GRdz6ke21bFTRg986xdEtXjcH3AYcNB-jMxDltjyxrqM6cN/exec"; 
        const API_KEY = "AIzaSyDxw8ulwIyPZJTeoIY0WJySj3HH4ns5r_U";
        
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-lite" });

        // --- 1. TOOL FUNCTIONS ---
        async function listEmails() {
            document.getElementById('status').innerText = "Fetching from Gmail...";
            // We use the proxy URL to read
            const response = await fetch(`${SCRIPT_URL}?action=read&q=is:unread`);
            const emails = await response.json();
            
            // Display visually
            const display = document.getElementById('displayArea');
            display.innerHTML = "";
            emails.forEach(e => {
                display.innerHTML += `<div class="email-item"><b>${e.from}</b>: ${e.subject}</div>`;
            });
            
            return JSON.stringify(emails);
        }

        async function sendEmail(to, subject, body) {
            document.getElementById('status').innerText = "Sending via Cloud...";
            // Apps Script requires a specific POST format
            // We use 'no-cors' mode or standard fetch depending on browser strictness. 
            // Standard fetch usually works if "Anyone" access is set in Apps Script.
            
            const response = await fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ to, subject, body })
            });
            const result = await response.json();
            return result.status;
        }

        // --- 2. AI LOGIC ---
        window.startAgent = async () => {
            const recognition = new webkitSpeechRecognition();
            recognition.start();
            document.getElementById('status').innerText = "Listening...";

            recognition.onresult = async (event) => {
                const text = event.results[0][0].transcript;
                document.getElementById('status').innerText = "Thinking...";

                // Prompt the AI to decide what to do
                const prompt = `
                    User Command: "${text}"
                    
                    You have two tools:
                    1. READ: If user wants to check/read emails. Output JSON: {"tool": "read"}
                    2. SEND: If user wants to send. Output JSON: {"tool": "send", "to": "email", "subject": "...", "body": "..."}
                    
                    Return ONLY JSON.
                `;

                const result = await model.generateContent(prompt);
                const responseText = result.response.text().replace(/```json|```/g, '').trim();
                const action = JSON.parse(responseText);

                if (action.tool === "read") {
                    const emails = await listEmails();
                    // Ask AI to summarize the emails naturally
                    const summary = await model.generateContent(`Here are the user's emails: ${emails}. Summarize them for voice output.`);
                    speak(summary.response.text());
                } 
                else if (action.tool === "send") {
                    await sendEmail(action.to, action.subject, action.body);
                    speak("Email sent successfully.");
                    document.getElementById('status').innerText = "Sent!";
                }
            };
        };

        function speak(text) {
            const u = new SpeechSynthesisUtterance(text);
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>