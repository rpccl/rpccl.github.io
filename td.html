<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Voice Controlled Todo App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    ul { list-style: none; padding: 0; }
    li { margin: 6px 0; }
  </style>
</head>
<body>

  <h1>Voice Controlled Todo App</h1>
  <button id="listenBtn">Start Voice Command</button>
  <p id="transcript"></p>
  <ul id="todoList"></ul>

<script>
// â€”â€”â€” LOCAL STORAGE â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
function loadTodos(){
  return JSON.parse(localStorage.getItem("todos") || "[]");
}
function saveTodos(t){
  localStorage.setItem("todos", JSON.stringify(t));
}
function render(){
  const list = document.getElementById("todoList");
  list.innerHTML = "";
  loadTodos().forEach((td,i)=>{
    const li = document.createElement("li");
    li.textContent = td.text;
    list.appendChild(li);
  });
}
render();

// â€”â€”â€” VOICE RECOGNITION â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
const listenBtn = document.getElementById("listenBtn");
const transcriptEl = document.getElementById("transcript");

const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recog = new Recognition();
recog.lang = "en-US";

listenBtn.onclick = () => recog.start();

recog.onresult = async (e) => {
  const text = e.results[0][0].transcript;
  transcriptEl.innerText = "You said: " + text;

  const json = await getTodosFromAI(text);
  if(json) handleJSON(json);
  render();
};

// â€”â€”â€” GEMINI API CALL â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
async function getTodosFromAI(text){
  const key = "AIzaSyDxw8ulwIyPZJTeoIY0WJySj3HH4ns5r_U";  // ðŸ”‘ Put your key
  const prompt = `
You will be given a voice command about todos.
Respond only with valid JSON with keys:
create: [], update: [{old, new}], delete: [].
Do NOT add any explanation.

Voice command:
"${text}"
`;

  // free text model
  const model = "gemini-2.0-flash";

  const body = {
    model,
    input: prompt,
  };

  try {
    const r = await fetch(
      "https://generativelanguage.googleapis.com/v1beta2/models:generateText?key=" + key,
      {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(body)
      }
    );
    const data = await r.json();
    const out = data.output?.text || "";
    return JSON.parse(out);
  } catch(err){
    console.error("AI Error", err);
    return null;
  }
}

// â€”â€”â€” HANDLE JSON â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
function handleJSON(j){
  const todos = loadTodos();

  if(j.create){
    j.create.forEach(t => todos.push({ text: t }));
  }
  if(j.update){
    j.update.forEach(u => {
      const idx = todos.findIndex(td => td.text.toLowerCase().includes(u.old.toLowerCase()));
      if(idx >= 0) todos[idx].text = u.new;
    });
  }
  if(j.delete){
    j.delete.forEach(d => {
      const idx = todos.findIndex(td => td.text.toLowerCase().includes(d.toLowerCase()));
      if(idx >= 0) todos.splice(idx,1);
    });
  }

  saveTodos(todos);
}

</script>
</body>
</html>
