<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Voice Todo App</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: sans-serif;
  max-width: 700px;
  margin: auto;
  padding: 1rem;
}
button, input {
  font-size: 1rem;
  padding: 0.5rem;
}
li {
  margin: 0.4rem 0;
}
.done {
  text-decoration: line-through;
  opacity: 0.6;
}
</style>
</head>

<body>

<h1>AI Voice Todo App</h1>

<button id="voiceBtn">üé§ Speak</button>
<p id="status" aria-live="polite">Loading AI‚Ä¶</p>

<hr>

<h2>Add Todo Manually</h2>
<input id="manualText" placeholder="Enter task">
<button onclick="addManual()">Add</button>

<hr>

<h2>Your Todos</h2>
<ul id="todoList"></ul>

<script type="module">
/* ================= AI ENGINE ================= */
import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

const statusEl = document.getElementById("status");

const engine = await CreateMLCEngine(
  "Llama-3-8B-Instruct-q4f16_1",
  {
    initProgressCallback: p => {
      statusEl.innerText =
        "Loading AI model: " + Math.round(p.progress * 100) + "%";
    }
  }
);

statusEl.innerText = "AI ready. You can speak now.";

/* ================= STORAGE ================= */
const KEY = "todos-ai";

function loadTodos() {
  return JSON.parse(localStorage.getItem(KEY)) || [];
}

function saveTodos(todos) {
  localStorage.setItem(KEY, JSON.stringify(todos));
  render();
}

/* ================= SPEECH ================= */
const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
const rec = new Rec();
rec.lang = "en-IN";

function speak(text) {
  speechSynthesis.speak(new SpeechSynthesisUtterance(text));
  statusEl.innerText = text;
}

/* ================= UI ================= */
function render() {
  const list = document.getElementById("todoList");
  list.innerHTML = "";
  loadTodos().forEach((t, i) => {
    const li = document.createElement("li");
    li.className = t.done ? "done" : "";
    li.innerHTML = `
      <input type="checkbox" ${t.done ? "checked" : ""} 
        onchange="toggle(${i})">
      ${t.text}
      <button onclick="removeTodo(${i})">‚ùå</button>
    `;
    list.appendChild(li);
  });
}

window.toggle = i => {
  const todos = loadTodos();
  todos[i].done = !todos[i].done;
  saveTodos(todos);
};

window.removeTodo = i => {
  const todos = loadTodos();
  todos.splice(i, 1);
  saveTodos(todos);
};

window.addManual = () => {
  const input = document.getElementById("manualText");
  if (!input.value.trim()) return;
  const todos = loadTodos();
  todos.push({ text: input.value.trim(), done: false });
  saveTodos(todos);
  input.value = "";
};

/* ================= AI PROMPT ================= */
async function askAI(command) {
  const prompt = `
You are a todo assistant.

User command:
"${command}"

Existing todos:
${JSON.stringify(loadTodos())}

Return ONLY valid JSON in this exact format:
{
  "actions": [
    {
      "intent": "create|read|update|delete",
      "text": "task text"
    }
  ]
}
`;

  const res = await engine.chat.completions.create({
    messages: [{ role: "user", content: prompt }],
    temperature: 0
  });

  return JSON.parse(res.choices[0].message.content);
}

/* ================= APPLY ACTIONS ================= */
function applyActions(actions) {
  let todos = loadTodos();

  actions.forEach(a => {
    if (a.intent === "create") {
      todos.push({ text: a.text, done: false });
    }

    if (a.intent === "update") {
      todos.forEach(t => {
        if (t.text.toLowerCase().includes(a.text.toLowerCase()))
          t.done = true;
      });
    }

    if (a.intent === "delete") {
      todos = todos.filter(
        t => !t.text.toLowerCase().includes(a.text.toLowerCase())
      );
    }

    if (a.intent === "read") {
      if (!todos.length) speak("You have no tasks.");
      else speak(
        todos
          .filter(t => !t.done)
          .map((t, i) => `${i + 1}. ${t.text}`)
          .join(". ")
      );
    }
  });

  saveTodos(todos);
}

/* ================= VOICE CONTROLLER ================= */
rec.onresult = async e => {
  const spoken = e.results[0][0].transcript;
  speak("Thinking");

  try {
    const ai = await askAI(spoken);
    applyActions(ai.actions);
    speak("Done");
  } catch {
    speak("Sorry, I could not understand.");
  }
};

document.getElementById("voiceBtn").onclick = () => rec.start();

/* ================= INIT ================= */
render();
</script>

</body>
</html>
