<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Voice Todo (Gemini)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<h1>AI Voice Todo</h1>
<button id="listen">ðŸŽ¤ Speak</button>
<div id="status" aria-live="polite"></div>

<script>
/* ================= CONFIG ================= */
const GEMINI_API_KEY = "AIzaSyDxw8ulwIyPZJTeoIY0WJySj3HH4ns5r_U";
const GEMINI_MODEL = "gemini-1.5-flash";

/* ================= STORAGE ================= */
const STORAGE_KEY = "ai_todos";

function loadTodos() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
}

function saveTodos(todos) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(todos));
}

/* ================= SPEECH ================= */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = new SpeechRecognition();
recognition.lang = "en-IN";
recognition.interimResults = false;

function speak(text) {
  speechSynthesis.cancel();
  speechSynthesis.speak(new SpeechSynthesisUtterance(text));
  document.getElementById("status").innerText = text;
}

/* ================= GEMINI CALL ================= */
async function callGemini(command, todos) {
  const prompt = `
You are a todo control engine.

Your response will be EXECUTED by the application.
Return ONLY valid JSON.
DO NOT add explanations, comments, or markdown.

User command:
"${command}"

Current todos:
${JSON.stringify(todos)}

Return JSON EXACTLY in this format:
{
  "actions": [
    {
      "intent": "create|read|update|delete",
      "text": "task text or empty string",
      "done": true|false|null
    }
  ]
}
`;

  const response = await fetch(
    "https://generativelanguage.googleapis.com/v1beta/models/" +
      GEMINI_MODEL +
      ":generateContent?key=" +
      GEMINI_API_KEY,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { temperature: 0 }
      })
    }
  );

  const data = await response.json();
  const text = data.candidates[0].content.parts[0].text.trim();
  return JSON.parse(text);
}

/* ================= ACTION ENGINE ================= */
function applyActions(actions) {
  let todos = loadTodos();

  actions.forEach(a => {
    if (a.intent === "create" && a.text) {
      todos.push({ text: a.text, done: false });
    }

    if (a.intent === "update" && a.text) {
      todos.forEach(t => {
        if (t.text.toLowerCase().includes(a.text.toLowerCase())) {
          if (a.done !== null) t.done = a.done;
        }
      });
    }

    if (a.intent === "delete" && a.text) {
      todos = todos.filter(
        t => !t.text.toLowerCase().includes(a.text.toLowerCase())
      );
    }

    if (a.intent === "read") {
      const pending = todos.filter(t => !t.done);
      if (pending.length === 0) {
        speak("You have no pending tasks.");
      } else {
        speak(
          pending
            .map((t, i) => `${i + 1}. ${t.text}`)
            .join(". ")
        );
      }
    }
  });

  saveTodos(todos);
}

/* ================= CONTROLLER ================= */
recognition.onresult = async e => {
  const spoken = e.results[0][0].transcript;
  speak("Processing");

  try {
    const todos = loadTodos();
    const aiResult = await callGemini(spoken, todos);
    applyActions(aiResult.actions);
    speak("Done");
  } catch (err) {
    speak("I could not understand that command.");
  }
};

document.getElementById("listen").onclick = () => {
  recognition.start();
  document.getElementById("status").innerText = "Listeningâ€¦";
};
</script>

</body>
</html>
