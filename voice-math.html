<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voice Math Practice</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  padding: 20px;
}
label {
  display: block;
  margin-top: 12px;
  font-weight: bold;
}
select, input, button {
  padding: 8px;
  width: 100%;
  max-width: 420px;
  margin-top: 4px;
}
#question {
  margin-top: 20px;
  font-size: 1.6em;
  font-weight: bold;
}
#feedback {
  margin-top: 10px;
  font-size: 1.2em;
}
.hidden { display: none; }
</style>
</head>
<body>

<h1>Voice Math Practice</h1>

<label for="category">Category</label>
<select id="category">
  <option value="random">Random</option>
  <option value="add">Addition</option>
  <option value="sub">Subtraction</option>
  <option value="mul">Multiplication</option>
  <option value="div">Division</option>
  <option value="rem">Remainder</option>
  <option value="avg">Average</option>
</select>

<label for="min">Minimum Number</label>
<input type="number" id="min" value="1">

<label for="max">Maximum Number</label>
<input type="number" id="max" value="10">

<label for="time">Time (minutes)</label>
<input type="number" id="time" value="1">

<button id="startBtn">Start</button>

<div id="question"></div>
<div id="feedback"></div>

<label for="answerInput" id="answerLabel" class="hidden">Your Answer</label>
<input type="text" id="answerInput" class="hidden">

<script>
const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

let recognition = null;
let recognitionActive = false;
let sessionRunning = false;

let correctAnswer = null;
let endTime = null;

const questionDiv = document.getElementById('question');
const feedbackDiv = document.getElementById('feedback');
const answerInput = document.getElementById('answerInput');
const answerLabel = document.getElementById('answerLabel');

function speak(text) {
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  window.speechSynthesis.speak(u);
}

function rand(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function generateQuestion() {
  if (Date.now() > endTime) {
    sessionRunning = false;
    speak("Time over. Session ended.");
    stopRecognition();
    return;
  }

  const catSel = category.value;
  const min = Number(document.getElementById('min').value);
  const max = Number(document.getElementById('max').value);

  let cat = catSel === 'random'
    ? ['add','sub','mul','div','rem','avg'][rand(0,5)]
    : catSel;

  let a, b, q;

  switch (cat) {
    case 'add':
      a = rand(min,max); b = rand(min,max);
      correctAnswer = a + b;
      q = `${a} plus ${b}`;
      break;
    case 'sub':
      a = rand(min,max); b = rand(min,max);
      correctAnswer = a - b;
      q = `${a} minus ${b}`;
      break;
    case 'mul':
      a = rand(min,max); b = rand(min,max);
      correctAnswer = a * b;
      q = `${a} multiplied by ${b}`;
      break;
    case 'div':
      b = rand(min,max);
      correctAnswer = rand(min,max);
      a = b * correctAnswer;
      q = `${a} divided by ${b}`;
      break;
    case 'rem':
      b = rand(min,max);
      correctAnswer = rand(0, b - 1);
      a = rand(min,max) * b + correctAnswer;
      q = `remainder when ${a} is divided by ${b}`;
      break;
    case 'avg':
      a = rand(min,max); b = rand(min,max);
      correctAnswer = (a + b) / 2;
      q = `average of ${a} and ${b}`;
      break;
  }

  questionDiv.textContent = "Question: " + q;
  feedbackDiv.textContent = "";
  speak(q);
}

function normalizeSpeech(text) {
  return text
    .toLowerCase()
    .replace(/minus\s+/g, '-')
    .replace(/negative\s+/g, '-');
}

function extractNumber(text) {
  const m = text.match(/-?\d+(\.\d+)?/);
  return m ? Number(m[0]) : null;
}

function checkAnswerFromSpeech(transcript) {
  const normalized = normalizeSpeech(transcript);
  const spokenNumber = extractNumber(normalized);

  const correctStr = String(correctAnswer);

  let isCorrect = false;

  if (spokenNumber !== null && Number(spokenNumber) === Number(correctAnswer)) {
    isCorrect = true;
  } else if (normalized.includes(correctStr)) {
    isCorrect = true;
  }

  handleResult(isCorrect);
}

function handleResult(isCorrect) {
  if (isCorrect) {
    feedbackDiv.textContent = "Correct";
    speak("Correct");
  } else {
    feedbackDiv.textContent = "Wrong. Correct answer is " + correctAnswer;
    speak("Wrong. Correct answer is " + correctAnswer);
  }
  setTimeout(generateQuestion, 900);
}

function startRecognition() {
  if (!SpeechRecognition || recognitionActive) return;

  recognition = new SpeechRecognition();
  recognition.lang = 'en-US';
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = (e) => {
    const transcript = e.results[e.results.length - 1][0].transcript;
    checkAnswerFromSpeech(transcript);
  };

  recognition.onerror = () => {
    if (!sessionRunning) return;
    stopRecognition();
    setTimeout(startRecognition, 500);
  };

  recognition.onend = () => {
    if (sessionRunning) {
      stopRecognition();
      setTimeout(startRecognition, 300);
    }
  };

  recognition.start();
  recognitionActive = true;
}

function stopRecognition() {
  if (recognition) {
    recognition.onend = null;
    recognition.onerror = null;
    recognition.stop();
    recognition = null;
  }
  recognitionActive = false;
}

answerInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    const val = Number(answerInput.value);
    answerInput.value = '';
    handleResult(Number(val) === Number(correctAnswer));
  }
});

document.getElementById('startBtn').onclick = () => {
  endTime = Date.now() + Number(time.value) * 60000;
  sessionRunning = true;

  answerLabel.classList.remove('hidden');
  answerInput.classList.remove('hidden');
  answerInput.focus();

  generateQuestion();
  startRecognition();
};
</script>

</body>
</html>
