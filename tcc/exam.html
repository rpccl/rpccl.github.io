<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taking Exam - Tanya Computer Center</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Exam Specific Styles */
        .status-bar {
            background: #2c3e50;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .timer-box {
            background: #e74c3c;
            padding: 5px 15px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 1.2em;
        }
        .review-panel {
            margin-top: 30px;
            border: 2px solid #f39c12;
            background: #fcf3cf;
            padding: 20px;
        }
        .review-list {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .review-item {
            background: white;
            border: 1px solid #f39c12;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        .review-item:hover { background: #f39c12; color: white; }
    </style>
</head>
<body>

    <header class="status-bar" role="banner">
        <div>
            <strong>Candidate:</strong> <span id="display-name">...</span> | 
            <strong>Roll:</strong> <span id="display-roll">...</span>
        </div>
        <div id="timer-display" class="timer-box" >Loading Time...</div>
    </header>

    <main class="container" style="margin-top: 20px;">
        
        <div id="question-area">
            <h2 id="question-count">Question 1</h2>
            
            <fieldset>
                <legend aria-live="polite" id="question-text" style="font-size: 1.2em; margin-bottom: 15px; display:block;">Loading Question...</legend>
                
                <div id="options-container" class="options-grid">
                    </div>
            </fieldset>

            <div style="margin: 20px 0; display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="chk-review" onchange="toggleMarkReview()" style="width: 20px; height: 20px;">
                <label for="chk-review" style="font-weight: bold; cursor: pointer;">Mark this question for review</label>
            </div>

            <div class="nav-buttons">
                <button id="btn-prev" onclick="navigate(-1)" disabled>Previous</button>
                <button id="btn-next" onclick="navigate(1)">Next</button>
                <button aria-live="polite" id="btn-submit" onclick="submitExam()" style="background: #dc3545; margin-left: auto;">Submit Final Exam</button>
            </div>
        </div>

        <button onclick="document.getElementById('review-section').classList.toggle('hidden')" style="margin-top: 30px; background: #f39c12; color: black;">
            Show/Hide Marked Questions
        </button>

        <div id="review-section" class="review-panel hidden" role="region" aria-label="Review List">
            <h3>Questions Marked for Review</h3>
            <ul id="review-list" class="review-list">
                <li>No questions marked.</li>
            </ul>
        </div>

    </main>
<script src="config.js"></script>


    <script>
        // --- CONFIG ---
//        const API_URL = "http://localhost:3000/api"; 
        const TOKEN = localStorage.getItem('tcc_token');
        const STUDENT = JSON.parse(localStorage.getItem('tcc_student'));
        const EXAM_ID = localStorage.getItem('tcc_current_exam_id');

        // --- AUTH & SAFETY CHECK ---
        if (!TOKEN || !STUDENT || !EXAM_ID) {
            window.location.href = 'index.html';
        }

        // --- STATE ---
        let state = {
            sessionId: null,
            questions: [],
            currentIndex: 0,
            answers: {}, 
            markedForReview: [], 
            endTime: null
        };

        // --- INITIALIZATION ---
        async function initExam() {
            // UI Setup
            document.getElementById('display-name').innerText = STUDENT.name;
            document.getElementById('display-roll').innerText = STUDENT.rollNo;

            try {
                // 1. Start/Resume Session
                const res = await fetch(`${API_URL}/exam/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TOKEN}` // Sending Token
                    },
                    body: JSON.stringify({ examId: EXAM_ID })
                });

                if (res.status === 403) {
                    const data = await res.json();
                    alert(data.error); // "Exam not started" or "Already submitted"
                    window.location.href = 'exam-list.html';
                    return;
                }

                const data = await res.json();

                // 2. Load Data into State
                state.sessionId = data.session._id;
                state.questions = data.questions;
                
                // Restore previous progress if any
                if (data.session.answers) state.answers = data.session.answers;
                if (data.session.markedForReview) state.markedForReview = data.session.markedForReview;
                if (data.session.currentQuestionIndex) state.currentIndex = data.session.currentQuestionIndex;

                // 3. Timer Logic (Server Authoritative)
                // We calculate end time based on START time + DURATION
                const startTime = new Date(data.session.startTimestamp).getTime();
                const durationMs = data.examDuration * 60 * 1000;
                state.endTime = startTime + durationMs;

                // Start App
                renderQuestion();
                updateReviewList();
                setInterval(updateTimer, 1000);
                setInterval(syncProgress, 30000); // Auto-save every 30s

            } catch (err) {
                console.error(err);
                alert("Failed to load exam. Please check connection and refresh.");
            }
        }

        // --- RENDERING ---
        function renderQuestion() {
            const q = state.questions[state.currentIndex];
            
            // Text
            document.getElementById('question-count').innerText = `Question ${state.currentIndex + 1} of ${state.questions.length}`;
            document.getElementById('question-text').innerText = q.questionText;

            // Options
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            ['A', 'B', 'C', 'D'].forEach(opt => {
                // Only show if option text exists
                if(q.options[opt]) {
                    const isChecked = state.answers[q._id] === opt ? 'checked' : '';
                    container.innerHTML += `
                        <label for = opt class="option-label">
                            <input id=opt type="radio" name="q_${q._id}" value="${opt}" ${isChecked} onchange="saveAnswer('${q._id}', '${opt}')">
                            <span style="font-weight:bold; margin-right:10px;">${opt}.</span> ${q.options[opt]}
                        </label>
                    `;
                }
            });

            // Mark for Review Checkbox
            document.getElementById('chk-review').checked = state.markedForReview.includes(q._id);

            // Nav Buttons
            document.getElementById('btn-prev').disabled = state.currentIndex === 0;
            
            // Hide "Next" on last question, show "Submit" is always there but highlighted
            if (state.currentIndex === state.questions.length - 1) {
                document.getElementById('btn-next').style.display = 'none';
            } else {
                document.getElementById('btn-next').style.display = 'inline-block';
                document.getElementById('btn-next').innerText = "Next Question";
            }
        }

        // --- INTERACTION ---
        function navigate(dir) {
            state.currentIndex += dir;
            renderQuestion();
            syncProgress(); // Sync on navigation for safety
        }

        function saveAnswer(qId, val) {
            state.answers[qId] = val;
        }

        function toggleMarkReview() {
            const qId = state.questions[state.currentIndex]._id;
            const chk = document.getElementById('chk-review');

            if (chk.checked) {
                if (!state.markedForReview.includes(qId)) state.markedForReview.push(qId);
            } else {
                state.markedForReview = state.markedForReview.filter(id => id !== qId);
            }
            updateReviewList();
        }

        function jumpToQuestion(idx) {
            state.currentIndex = idx;
            renderQuestion();
        }

        function updateReviewList() {
            const list = document.getElementById('review-list');
            list.innerHTML = '';
            if (state.markedForReview.length === 0) {
                list.innerHTML = '<li>No questions marked.</li>';
                return;
            }
            state.markedForReview.forEach(qId => {
                const idx = state.questions.findIndex(q => q._id === qId);
                list.innerHTML += `<li class="review-item" onclick="jumpToQuestion(${idx})">Q${idx + 1}</li>`;
            });
        }

        // --- TIMER ---
        function updateTimer() {
            const now = new Date().getTime();
            const distance = state.endTime - now;

            if (distance < 0) {
                document.getElementById('timer-display').innerText = "TIME UP";
                submitExam(true); // Force Submit
                return;
            }

            const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((distance % (1000 * 60)) / 1000);
            document.getElementById('timer-display').innerText = `Time Left: ${m}m ${s}s`;
        }

        // --- SERVER SYNC ---
        async function syncProgress() {
            try {
                await fetch(`${API_URL}/exam/save-progress`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TOKEN}`
                    },
                    body: JSON.stringify({
                        sessionId: state.sessionId,
                        currentQuestionIndex: state.currentIndex,
                        answers: state.answers,
                        markedForReview: state.markedForReview
                    })
                });
            } catch (e) {
                console.warn("Sync failed (background)");
            }
        }

        // --- SUBMIT ---
        async function submitExam(force = false) {
            if (!force && !confirm("Are you sure you want to finish the exam? This cannot be undone.")) return;

            // Final Sync
            await syncProgress();

            document.querySelector('main').innerHTML = "<h2 aria-live='polite' >Submitting your answers...</h2>";

            try {
                const res = await fetch(`${API_URL}/exam/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TOKEN}`
                    },
                    body: JSON.stringify({ sessionId: state.sessionId })
                });

                const data = await res.json();

                if (res.ok) {
                    document.querySelector('main').innerHTML = `
                        <div style="text-align:center; margin-top:50px;">
                            <h1 style="color:green;" aria-live="polite" >Exam Submitted Successfully</h1>
                            <h3>Your Score: ${data.score}</h3>
                            <p>You may close this window or logout.</p>
                            <button onclick="window.location.href='index.html'" class="btn-primary">Return Home</button>
                        </div>
                    `;
                    localStorage.removeItem('tcc_current_exam_id');
                } else {
                    alert("Submission error: " + (data.error || "Unknown"));
                    window.location.reload(); // Reload to try again
                }
            } catch (e) {
                alert("Network failed during submission. DO NOT CLOSE. Try again.");
                document.querySelector('main').innerHTML += "<button onclick='submitExam(true)'>Retry Submit</button>";
            }
        }

        // Boot
        initExam();
    </script>
</body>
</html>